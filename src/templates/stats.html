{% extends "template.html" %}
{% block content %}

<!-- show the QR code stats, i.e. the url it points to and the counter using bootstrap-->
<div class="container align-items-center" id="main-form">
    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-body">
                    <h2>QR code stats</h2>
                    <div class="mb-3">
                        <p class="mb-1"><strong>QR code URL:</strong></p>
                        <p class="mb-2">
                            <code id="qrCodeUrl" style="background-color: #f8f9fa; padding: 0.5rem; border-radius: 0.25rem; display: inline-block; word-break: break-all;"></code>
                        </p>
                        <p class="mb-1"><strong>Points to:</strong></p>
                        <p class="mb-3">
                            <a href="//{{ url }}" target="_blank">{{ url }}</a>
                        </p>
                    </div>
                    {% if date %}
                        <p class="mb-3">QR code has been scanned <strong>{{ counter }}</strong> time at {{ date }}</p>
                    {% else %}
                       <p class="mb-3">QR code has been scanned <strong>{{ counter }}</strong> times</p>
                    {% endif %}
                    <div class="d-flex justify-content-center mb-3">
                        <div id="qrcode"></div>
                    </div>
                    <script type="text/javascript">
                        function generateQRCode() {
                            // Check if QRCodeStyling is available
                            if (typeof QRCodeStyling === 'undefined') {
                                console.error('QRCodeStyling library not loaded');
                                const qrElement = document.getElementById('qrcode');
                                if (qrElement) {
                                    qrElement.innerHTML = '<p class="text-danger">Error: QR code library not loaded. Please refresh the page.</p><p class="text-muted">Check browser console for details.</p>';
                                }
                                return;
                            }
                            
                            try {
                                // Use the public QR code URL passed from server
                                {% if public_qr_url %}
                                const qrCodeUrl = {{ public_qr_url | tojson }};
                                {% else %}
                                const qrCodeUrl = '';
                                console.error('public_qr_url not provided by server');
                                {% endif %}
                                if (!qrCodeUrl || qrCodeUrl === '') {
                                    const qrElement = document.getElementById('qrCodeUrl');
                                    if (qrElement) {
                                        qrElement.textContent = 'Error: QR code URL not available';
                                    }
                                    return;
                                }
                                document.getElementById('qrCodeUrl').textContent = qrCodeUrl;
                                
                                // Build QR code configuration from server config
                                const qrConfig = {{ qr_config | tojson }};
                                
                                // Map error correction level
                                const errorCorrectionMap = {
                                    "L": "L",
                                    "M": "M",
                                    "Q": "Q",
                                    "H": "H"
                                };
                                const errorCorrectionLevel = errorCorrectionMap[qrConfig.correct_level || "H"] || "H";
                                
                                // Build dots configuration
                                const dotsOptions = {
                                    type: qrConfig.dot_type || "square",
                                    color: qrConfig.color_dark || "#000000"
                                };
                                
                                
                                // Build corners configuration
                                const cornersSquareOptions = {
                                    type: qrConfig.corner_square_type || "square",
                                    color: qrConfig.color_dark || "#000000"
                                };
                                
                                const cornersDotOptions = {
                                    type: qrConfig.corner_dot_type || "square",
                                    color: qrConfig.color_dark || "#000000"
                                };
                                
                                // Build background configuration
                                const backgroundOptions = {
                                    color: qrConfig.color_light || "#ffffff"
                                };
                                
                                // Build QR code configuration object
                                // Use size if available, otherwise fall back to width (for backward compatibility)
                                const size = qrConfig.size || qrConfig.width || 512;
                                const qrCodeConfig = {
                                    width: size,
                                    height: size,
                                    type: "canvas",
                                    data: qrCodeUrl,
                                    margin: qrConfig.margin || 4,
                                    qrOptions: {
                                        typeNumber: 0,
                                        mode: "Byte",
                                        errorCorrectionLevel: errorCorrectionLevel
                                    },
                                    dotsOptions: dotsOptions,
                                    cornersSquareOptions: cornersSquareOptions,
                                    cornersDotOptions: cornersDotOptions,
                                    backgroundOptions: backgroundOptions
                                };
                                
                                // Add image/logo configuration only if logo is provided
                                // According to QRCodeStyling docs: image is top-level, imageOptions contains crossOrigin and other options
                                if (qrConfig.logo_image && typeof qrConfig.logo_image === 'string' && qrConfig.logo_image.trim() !== "") {
                                    qrCodeConfig.image = qrConfig.logo_image.trim();
                                    qrCodeConfig.imageOptions = {
                                        crossOrigin: "anonymous",
                                        hideBackgroundDots: true,
                                        margin: qrConfig.logo_margin || 3,
                                        imageSize: qrConfig.logo_size || 0.3
                                    };
                                }
                                
                                // Create QR code with styling
                                const qrCode = new QRCodeStyling(qrCodeConfig);
                                
                                const qrElement = document.getElementById("qrcode");
                                if (qrElement) {
                                    qrCode.append(qrElement);
                                } else {
                                    console.error('QR code container element not found');
                                }
                            } catch (error) {
                                console.error('Error generating QR code:', error);
                                const qrElement = document.getElementById("qrcode");
                                if (qrElement) {
                                    qrElement.innerHTML = '<p class="text-danger">Error generating QR code. Please check the browser console.</p>';
                                }
                            }
                        }
                        
                        // Wait for DOM and library to be ready
                        function waitForLibrary(attempts) {
                            attempts = attempts || 0;
                            if (attempts > 50) {
                                console.error('QRCodeStyling library failed to load after 5 seconds');
                                const qrElement = document.getElementById('qrcode');
                                if (qrElement) {
                                    qrElement.innerHTML = '<p class="text-danger">Error: QR code library failed to load. Please refresh the page.</p>';
                                }
                                return;
                            }
                            
                            if (typeof QRCodeStyling !== 'undefined') {
                                generateQRCode();
                            } else {
                                // Try again after a short delay
                                setTimeout(function() { waitForLibrary(attempts + 1); }, 100);
                            }
                        }
                        
                        if (document.readyState === 'loading') {
                            document.addEventListener('DOMContentLoaded', function() {
                                waitForLibrary();
                            });
                        } else {
                            waitForLibrary();
                        }
                    </script>

                    {% if has_data %}
                    <div class="mt-4 mb-4">
                        <div class="d-flex justify-content-center">
                            <div style="max-width: 100%; width: 100%; height: 400px; position: relative;">
                                <canvas id="impressionsChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
                    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
                    <script type="text/javascript">
                        fetch('{{ url_for("admin.stats_data", id=id) }}')
                            .then(response => response.json())
                            .then(data => {
                                const datetimes = data.datetimes.map(d => new Date(d));
                                const chartData = datetimes.map((dt, idx) => ({
                                    x: dt,
                                    y: idx + 1
                                }));
                                
                                const ctx = document.getElementById('impressionsChart').getContext('2d');
                                new Chart(ctx, {
                                    type: 'line',
                                    data: {
                                        datasets: [{
                                            label: 'Impressions',
                                            data: chartData,
                                            borderColor: '#0d6efd',
                                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                                            borderWidth: 2,
                                            stepped: 'after',
                                            pointRadius: 0,
                                            fill: true,
                                            tension: 0
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        layout: {
                                            padding: {
                                                top: 10,
                                                bottom: 10,
                                                left: 10,
                                                right: 10
                                            }
                                        },
                                        scales: {
                                            x: {
                                                type: 'time',
                                                time: {
                                                    displayFormats: {
                                                        minute: 'HH:mm',
                                                        hour: 'MMM d, HH:mm',
                                                        day: 'MMM d, yyyy',
                                                        week: 'MMM d',
                                                        month: 'MMM yyyy'
                                                    },
                                                    tooltipFormat: 'MMM d, yyyy HH:mm'
                                                },
                                                title: {
                                                    display: true,
                                                    text: 'Time',
                                                    font: {
                                                        size: 14,
                                                        weight: 'bold'
                                                    },
                                                    color: '#495057'
                                                },
                                                grid: {
                                                    color: 'rgba(0, 0, 0, 0.1)',
                                                    drawBorder: true,
                                                    borderColor: 'rgba(0, 0, 0, 0.2)'
                                                },
                                                ticks: {
                                                    maxRotation: 45,
                                                    minRotation: 45,
                                                    color: '#6c757d',
                                                    font: {
                                                        size: 11
                                                    }
                                                }
                                            },
                                            y: {
                                                beginAtZero: true,
                                                ticks: {
                                                    stepSize: 1,
                                                    precision: 0,
                                                    color: '#6c757d',
                                                    font: {
                                                        size: 11
                                                    }
                                                },
                                                title: {
                                                    display: true,
                                                    text: 'Impressions',
                                                    font: {
                                                        size: 14,
                                                        weight: 'bold'
                                                    },
                                                    color: '#495057'
                                                },
                                                grid: {
                                                    color: 'rgba(0, 0, 0, 0.1)',
                                                    drawBorder: true,
                                                    borderColor: 'rgba(0, 0, 0, 0.2)'
                                                }
                                            }
                                        },
                                        plugins: {
                                            title: {
                                                display: true,
                                                text: 'Impressions over time',
                                                font: {
                                                    size: 18,
                                                    weight: 'bold'
                                                },
                                                color: '#212529',
                                                padding: {
                                                    top: 10,
                                                    bottom: 20
                                                }
                                            },
                                            legend: {
                                                display: false
                                            },
                                            tooltip: {
                                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                                padding: 10,
                                                titleFont: {
                                                    size: 13,
                                                    weight: 'bold'
                                                },
                                                bodyFont: {
                                                    size: 12
                                                },
                                                borderColor: 'rgba(255, 255, 255, 0.1)',
                                                borderWidth: 1,
                                                displayColors: false,
                                                callbacks: {
                                                    title: function(context) {
                                                        const date = new Date(context[0].parsed.x);
                                                        return date.toLocaleString();
                                                    },
                                                    label: function(context) {
                                                        return 'Impressions: ' + context.parsed.y;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                });
                            })
                            .catch(error => {
                                console.error('Error loading chart data:', error);
                            });
                    </script>
                    {% endif %}

                    <!-- Action buttons -->
                    <div class="text-center mb-3" id="action-buttons">
                        <button type="button" class="btn btn-secondary me-2" data-bs-toggle="modal" data-bs-target="#styleModal">Regenerate QR Code</button>
                        <button type="button" class="btn btn-warning me-2" data-bs-toggle="modal" data-bs-target="#resetModal">Reset Stats</button>
                        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">Delete Entry</button>
                    </div>

                    <!-- button to home page -->
                    <div class="text-center" id="back-home">
                        <button type="button" class="btn btn-primary" onclick="window.location.href='/'">Make another QR code</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Style Regeneration Modal -->
<div class="modal fade" id="styleModal" tabindex="-1" aria-labelledby="styleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="styleModalLabel">Regenerate QR Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('admin.update_style', id=id) }}" method="post" novalidate>
                <div class="modal-body">
                    {% if has_password %}
                    <div class="mb-3">
                        <label for="style_password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="style_password" name="password" required>
                        <div class="form-text">Password required to update QR code style</div>
                    </div>
                    {% endif %}
                    
                    <div class="mb-4">
                        <h6 class="mb-2">Preview</h6>
                        <div id="qrPreviewModal" class="d-flex justify-content-center align-items-center" style="min-height: 200px; border: 1px solid #dee2e6; border-radius: 0.25rem; background-color: #f8f9fa;">
                            <p class="text-muted mb-0">Loading preview...</p>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    <h5 class="mb-3">QR Code Styling</h5>
                    
                    <div class="mb-3">
                        <label for="qr_style_size" class="form-label">Size</label>
                        <input type="number" class="form-control" id="qr_style_size" name="qr_style_size" value="{{ qr_config.size | default(qr_config.width | default(512)) }}" min="100" max="2000">
                        <div class="form-text">QR codes are always square</div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="qr_style_color_dark" class="form-label">Dark Color</label>
                            <input type="color" class="form-control form-control-color" id="qr_style_color_dark" name="qr_style_color_dark" value="{{ qr_config.color_dark | default('#000000') }}" title="Choose dark color">
                        </div>
                        <div class="col-md-6">
                            <label for="qr_style_color_light" class="form-label">Light Color</label>
                            <input type="color" class="form-control form-control-color" id="qr_style_color_light" name="qr_style_color_light" value="{{ qr_config.color_light | default('#ffffff') }}" title="Choose light color">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="qr_style_dot_type" class="form-label">Dot Style</label>
                            <select class="form-select" id="qr_style_dot_type" name="qr_style_dot_type">
                                <option value="square" {% if (qr_config.dot_type | default('square')) == 'square' %}selected{% endif %}>Square</option>
                                <option value="rounded" {% if (qr_config.dot_type | default('square')) == 'rounded' %}selected{% endif %}>Rounded</option>
                                <option value="extra-rounded" {% if (qr_config.dot_type | default('square')) == 'extra-rounded' %}selected{% endif %}>Extra Rounded</option>
                                <option value="classy" {% if (qr_config.dot_type | default('square')) == 'classy' %}selected{% endif %}>Classy</option>
                                <option value="classy-rounded" {% if (qr_config.dot_type | default('square')) == 'classy-rounded' %}selected{% endif %}>Classy Rounded</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="qr_style_margin" class="form-label">Margin</label>
                            <input type="number" class="form-control" id="qr_style_margin" name="qr_style_margin" value="{{ qr_config.margin | default(4) }}" min="0" max="20">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <button class="btn btn-link p-0" type="button" data-bs-toggle="collapse" data-bs-target="#advancedStylingModal" aria-expanded="false" aria-controls="advancedStylingModal">
                            Advanced Options <i class="bi bi-chevron-down"></i>
                        </button>
                    </div>
                    
                    <div class="collapse" id="advancedStylingModal">
                        <div class="card card-body mb-3">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="qr_style_corner_square_type" class="form-label">Corner Square Style</label>
                                    <select class="form-select" id="qr_style_corner_square_type" name="qr_style_corner_square_type">
                                        <option value="none" {% if (qr_config.corner_square_type | default('square')) == 'none' %}selected{% endif %}>None</option>
                                        <option value="square" {% if (qr_config.corner_square_type | default('square')) == 'square' %}selected{% endif %}>Square</option>
                                        <option value="dot" {% if (qr_config.corner_square_type | default('square')) == 'dot' %}selected{% endif %}>Dot</option>
                                        <option value="extra-rounded" {% if (qr_config.corner_square_type | default('square')) == 'extra-rounded' %}selected{% endif %}>Extra Rounded</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="qr_style_corner_dot_type" class="form-label">Corner Dot Style</label>
                                    <select class="form-select" id="qr_style_corner_dot_type" name="qr_style_corner_dot_type">
                                        <option value="none" {% if (qr_config.corner_dot_type | default('square')) == 'none' %}selected{% endif %}>None</option>
                                        <option value="square" {% if (qr_config.corner_dot_type | default('square')) == 'square' %}selected{% endif %}>Square</option>
                                        <option value="dot" {% if (qr_config.corner_dot_type | default('square')) == 'dot' %}selected{% endif %}>Dot</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="qr_style_correct_level" class="form-label">Error Correction Level</label>
                                <select class="form-select" id="qr_style_correct_level" name="qr_style_correct_level">
                                    <option value="L" {% if (qr_config.correct_level | default('H')) == 'L' %}selected{% endif %}>L - Low (~7% recovery)</option>
                                    <option value="M" {% if (qr_config.correct_level | default('H')) == 'M' %}selected{% endif %}>M - Medium (~15% recovery)</option>
                                    <option value="Q" {% if (qr_config.correct_level | default('H')) == 'Q' %}selected{% endif %}>Q - Quartile (~25% recovery)</option>
                                    <option value="H" {% if (qr_config.correct_level | default('H')) == 'H' %}selected{% endif %}>H - High (~30% recovery)</option>
                                </select>
                            </div>
                            
                            <hr>
                            <h6>Logo Options</h6>
                            <div class="mb-3">
                                <label for="qr_style_logo_image" class="form-label">Logo Image URL</label>
                                <input type="url" class="form-control" id="qr_style_logo_image" name="qr_style_logo_image" value="{{ qr_config.logo_image | default('') }}" placeholder="https://example.com/logo.png">
                                <div class="form-text">Optional - URL to an image to embed in the center of the QR code</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="qr_style_logo_size" class="form-label">Logo Size</label>
                                    <input type="number" class="form-control" id="qr_style_logo_size" name="qr_style_logo_size" value="{{ qr_config.logo_size | default(0.3) }}" step="0.1" min="0.1" max="0.5">
                                    <div class="form-text">Size relative to QR code (0.1-0.5)</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="qr_style_logo_margin" class="form-label">Logo Margin</label>
                                    <input type="number" class="form-control" id="qr_style_logo_margin" name="qr_style_logo_margin" value="{{ qr_config.logo_margin | default(3) }}" min="0" max="10">
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update QR Code</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reset Stats Confirmation Modal -->
<div class="modal fade" id="resetModal" tabindex="-1" aria-labelledby="resetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resetModalLabel">Reset Stats</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('admin.reset_stats', id=id) }}" method="post" novalidate>
                <div class="modal-body">
                    <div class="alert alert-warning" role="alert">
                        <strong>Warning!</strong> This action will permanently delete all impression data for this QR code. This cannot be undone.
                    </div>
                    <p>Are you sure you want to reset the stats? All scan history will be lost.</p>
                    {% if has_password %}
                    <div class="mb-3">
                        <label for="reset_password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="reset_password" name="password" required>
                        <div class="form-text">Password required to reset stats</div>
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Reset Stats</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Entry Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Delete Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('admin.delete_entry', id=id) }}" method="post" novalidate>
                <div class="modal-body">
                    <div class="alert alert-danger" role="alert">
                        <strong>Danger!</strong> This action will permanently delete this QR code entry and all associated data. This cannot be undone.
                    </div>
                    <p>Are you sure you want to delete this entry? This will remove:</p>
                    <ul>
                        <li>The QR code association</li>
                        <li>All statistics and scan history</li>
                        <li>All styling configuration</li>
                    </ul>
                    <p><strong>After deletion, the QR code will no longer work.</strong></p>
                    {% if has_password %}
                    <div class="mb-3">
                        <label for="delete_password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="delete_password" name="password" required>
                        <div class="form-text">Password required to delete entry</div>
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete Entry</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Debounce utility function
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Shared function to build QR code configuration from form values
function buildQRCodeConfig(formValues, qrCodeUrl) {
    const errorCorrectionMap = {
        "L": "L",
        "M": "M",
        "Q": "Q",
        "H": "H"
    };
    const errorCorrectionLevel = errorCorrectionMap[formValues.correct_level || "H"] || "H";
    
    // Build dots configuration
    const dotsOptions = {
        type: formValues.dot_type || "square",
        color: formValues.color_dark || "#000000"
    };
    
    // Build corners configuration
    const cornersSquareOptions = {
        type: formValues.corner_square_type || "square",
        color: formValues.color_dark || "#000000"
    };
    
    const cornersDotOptions = {
        type: formValues.corner_dot_type || "square",
        color: formValues.color_dark || "#000000"
    };
    
    // Build background configuration
    const backgroundOptions = {
        color: formValues.color_light || "#ffffff"
    };
    
    
    // Build QR code configuration object
    const size = parseInt(formValues.size) || 512;
    const qrCodeConfig = {
        width: size,
        height: size,
        type: "canvas",
        data: qrCodeUrl,
        margin: parseInt(formValues.margin) || 4,
        qrOptions: {
            typeNumber: 0,
            mode: "Byte",
            errorCorrectionLevel: errorCorrectionLevel
        },
        dotsOptions: dotsOptions,
        cornersSquareOptions: cornersSquareOptions,
        cornersDotOptions: cornersDotOptions,
        backgroundOptions: backgroundOptions
    };
    
    // Add image/logo configuration only if logo is provided
    // According to QRCodeStyling docs: image is top-level, imageOptions contains crossOrigin and other options
    if (formValues.logo_image && typeof formValues.logo_image === 'string' && formValues.logo_image.trim() !== "") {
        qrCodeConfig.image = formValues.logo_image.trim();
        qrCodeConfig.imageOptions = {
            crossOrigin: "anonymous",
            hideBackgroundDots: true,
            margin: parseInt(formValues.logo_margin) || 3,
            imageSize: parseFloat(formValues.logo_size) || 0.3
        };
    }
    
    return qrCodeConfig;
}

// Collect form values from modal form
function collectModalFormValues() {
    return {
        size: document.getElementById('qr_style_size')?.value || '512',
        color_dark: document.getElementById('qr_style_color_dark')?.value || '#000000',
        color_light: document.getElementById('qr_style_color_light')?.value || '#ffffff',
        dot_type: document.getElementById('qr_style_dot_type')?.value || 'square',
        margin: document.getElementById('qr_style_margin')?.value || '4',
        corner_square_type: document.getElementById('qr_style_corner_square_type')?.value || 'square',
        corner_dot_type: document.getElementById('qr_style_corner_dot_type')?.value || 'square',
        correct_level: document.getElementById('qr_style_correct_level')?.value || 'H',
        logo_image: document.getElementById('qr_style_logo_image')?.value || '',
        logo_size: document.getElementById('qr_style_logo_size')?.value || '0.3',
        logo_margin: document.getElementById('qr_style_logo_margin')?.value || '3',
        gradient_type: document.getElementById('qr_style_gradient_type')?.value || '',
        gradient_color_start: document.getElementById('qr_style_gradient_color_start')?.value || '#000000',
        gradient_color_end: document.getElementById('qr_style_gradient_color_end')?.value || '#000000',
        gradient_rotation: document.getElementById('qr_style_gradient_rotation')?.value || '0',
        background_gradient_type: document.getElementById('qr_style_background_gradient_type')?.value || '',
        background_gradient_color_start: document.getElementById('qr_style_background_gradient_color_start')?.value || '#ffffff',
        background_gradient_color_end: document.getElementById('qr_style_background_gradient_color_end')?.value || '#ffffff',
        background_gradient_rotation: document.getElementById('qr_style_background_gradient_rotation')?.value || '0'
    };
}

// Generate QR code preview for modal
let modalQRCodeInstance = null;

function generateQRPreviewModal() {
    // Check if QRCodeStyling is available
    if (typeof QRCodeStyling === 'undefined') {
        const previewElement = document.getElementById('qrPreviewModal');
        if (previewElement) {
            previewElement.innerHTML = '<p class="text-danger">Error: QR code library not loaded. Please refresh the page.</p>';
        }
        return;
    }
    
    const previewElement = document.getElementById('qrPreviewModal');
    if (!previewElement) {
        return;
    }
    
    // Get QR code URL from server variable
    {% if public_qr_url %}
    const qrCodeUrl = {{ public_qr_url | tojson }};
    {% else %}
    const qrCodeUrl = '';
    {% endif %}
    
    if (!qrCodeUrl || qrCodeUrl === '') {
        previewElement.innerHTML = '<p class="text-danger">Error: QR code URL not available</p>';
        return;
    }
    
    try {
        const formValues = collectModalFormValues();
        
        // Clear previous QR code instance
        if (modalQRCodeInstance) {
            previewElement.innerHTML = '';
            modalQRCodeInstance = null;
        }
        
        // Build QR code configuration
        const qrCodeConfig = buildQRCodeConfig(formValues, qrCodeUrl);
        
        // Create QR code with styling
        // QRCodeStyling handles image loading internally, so we can pass URL directly
        modalQRCodeInstance = new QRCodeStyling(qrCodeConfig);
        modalQRCodeInstance.append(previewElement);
    } catch (error) {
        console.error('Error generating QR code preview:', error);
        const previewElement = document.getElementById('qrPreviewModal');
        if (previewElement) {
            previewElement.innerHTML = '<p class="text-danger">Error generating QR code preview. Please check the browser console.</p>';
        }
    }
}

// Debounced version of generateQRPreviewModal
const debouncedGenerateQRPreviewModal = debounce(generateQRPreviewModal, 300);

// Add event listeners to all modal form fields for preview updates
document.addEventListener('DOMContentLoaded', function() {
    const modalFormFields = [
        'qr_style_size', 'qr_style_color_dark', 'qr_style_color_light',
        'qr_style_dot_type', 'qr_style_margin', 'qr_style_corner_square_type', 'qr_style_corner_dot_type',
        'qr_style_correct_level', 'qr_style_logo_image', 'qr_style_logo_size', 'qr_style_logo_margin'
    ];
    
    modalFormFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', debouncedGenerateQRPreviewModal);
            field.addEventListener('change', debouncedGenerateQRPreviewModal);
        }
    });
    
    // Handle modal lifecycle events
    const styleModal = document.getElementById('styleModal');
    if (styleModal) {
        styleModal.addEventListener('shown.bs.modal', function() {
            // Wait a bit for modal to fully render, then generate preview
            setTimeout(function() {
                generateQRPreviewModal();
            }, 100);
        });
        
        styleModal.addEventListener('hidden.bs.modal', function() {
            // Clear preview when modal closes
            const previewElement = document.getElementById('qrPreviewModal');
            if (previewElement && modalQRCodeInstance) {
                previewElement.innerHTML = '<p class="text-muted mb-0">Loading preview...</p>';
                modalQRCodeInstance = null;
            }
        });
    }
});
</script>

{% endblock %}