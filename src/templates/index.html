{% extends "template.html" %}
{% block content %}

<!-- a simple form that just has a url input and a submit button -->
<!-- centered with boostrap -->
<div class="container align-items-center" id="main-form">
    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-body">
                    <form action="/" method="post" onload="data => {console.log(data)}" onerror="data => {console.log(data)}">
                        <div class="mb-3">
                            <label for="url" class="form-label">URL<i style="color: red">*</i></label>
                            {% if error %}
                                <input type="text" class="form-control is-invalid" id="url" name="url" aria-describedby="urlHelp" value="{{ url }}" required>
                                <div class="invalid-feedback">
                                    {{ error }}
                                </div>
                            {% else %}
                            	<input type="text" class="form-control" id="url" name="url" aria-describedby="urlHelp" required>
                            {% endif %}
                            <div id="urlHelp" class="form-text">Required - This will be the url that the QR code links to</div>
                        </div>
                        <div class="mb-3">
                            <label for="key" class="form-label">Key</label>
                            <input type="text" class="form-control" id="key" name="key" aria-describedby="keyHelp">
                            <div id="keyHelp" class="form-text">Optional - This will produce a link that ends with /&#60;key&#62;</div>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" name="password" aria-describedby="passwordHelp">
                            <div id="passwordHelp" class="form-text">Optional - The password will be required to view the QR code stats</div>
                        </div>
                        
                        <hr class="my-4">
                        <h5 class="mb-3">QR Code Styling</h5>
                        
                        <div class="mb-3">
                            <label for="qr_style_size" class="form-label">Size</label>
                            <input type="number" class="form-control" id="qr_style_size" name="qr_style_size" value="{{ qr_config.size | default(qr_config.width | default(512)) }}" min="100" max="2000">
                            <div class="form-text">QR codes are always square</div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="qr_style_color_dark" class="form-label">Dark Color</label>
                                <input type="color" class="form-control form-control-color" id="qr_style_color_dark" name="qr_style_color_dark" value="{{ qr_config.color_dark | default('#000000') }}" title="Choose dark color">
                            </div>
                            <div class="col-md-6">
                                <label for="qr_style_color_light" class="form-label">Light Color</label>
                                <input type="color" class="form-control form-control-color" id="qr_style_color_light" name="qr_style_color_light" value="{{ qr_config.color_light | default('#ffffff') }}" title="Choose light color">
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="qr_style_dot_type" class="form-label">Dot Style</label>
                                <select class="form-select" id="qr_style_dot_type" name="qr_style_dot_type">
                                    <option value="square" {% if (qr_config.dot_type | default('square')) == 'square' %}selected{% endif %}>Square</option>
                                    <option value="rounded" {% if (qr_config.dot_type | default('square')) == 'rounded' %}selected{% endif %}>Rounded</option>
                                    <option value="extra-rounded" {% if (qr_config.dot_type | default('square')) == 'extra-rounded' %}selected{% endif %}>Extra Rounded</option>
                                    <option value="classy" {% if (qr_config.dot_type | default('square')) == 'classy' %}selected{% endif %}>Classy</option>
                                    <option value="classy-rounded" {% if (qr_config.dot_type | default('square')) == 'classy-rounded' %}selected{% endif %}>Classy Rounded</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="qr_style_margin" class="form-label">Margin</label>
                                <input type="number" class="form-control" id="qr_style_margin" name="qr_style_margin" value="{{ qr_config.margin | default(4) }}" min="0" max="20">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <button class="btn btn-link p-0" type="button" data-bs-toggle="collapse" data-bs-target="#advancedStyling" aria-expanded="false" aria-controls="advancedStyling">
                                Advanced Options <i class="bi bi-chevron-down"></i>
                            </button>
                        </div>
                        
                        <div class="collapse" id="advancedStyling">
                            <div class="card card-body mb-3">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="qr_style_corner_square_type" class="form-label">Corner Square Style</label>
                                        <select class="form-select" id="qr_style_corner_square_type" name="qr_style_corner_square_type">
                                            <option value="none" {% if (qr_config.corner_square_type | default('square')) == 'none' %}selected{% endif %}>None</option>
                                            <option value="square" {% if (qr_config.corner_square_type | default('square')) == 'square' %}selected{% endif %}>Square</option>
                                            <option value="dot" {% if (qr_config.corner_square_type | default('square')) == 'dot' %}selected{% endif %}>Dot</option>
                                            <option value="extra-rounded" {% if (qr_config.corner_square_type | default('square')) == 'extra-rounded' %}selected{% endif %}>Extra Rounded</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="qr_style_corner_dot_type" class="form-label">Corner Dot Style</label>
                                        <select class="form-select" id="qr_style_corner_dot_type" name="qr_style_corner_dot_type">
                                            <option value="none" {% if (qr_config.corner_dot_type | default('square')) == 'none' %}selected{% endif %}>None</option>
                                            <option value="square" {% if (qr_config.corner_dot_type | default('square')) == 'square' %}selected{% endif %}>Square</option>
                                            <option value="dot" {% if (qr_config.corner_dot_type | default('square')) == 'dot' %}selected{% endif %}>Dot</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="qr_style_correct_level" class="form-label">Error Correction Level</label>
                                    <select class="form-select" id="qr_style_correct_level" name="qr_style_correct_level">
                                        <option value="L" {% if (qr_config.correct_level | default('H')) == 'L' %}selected{% endif %}>L - Low (~7% recovery)</option>
                                        <option value="M" {% if (qr_config.correct_level | default('H')) == 'M' %}selected{% endif %}>M - Medium (~15% recovery)</option>
                                        <option value="Q" {% if (qr_config.correct_level | default('H')) == 'Q' %}selected{% endif %}>Q - Quartile (~25% recovery)</option>
                                        <option value="H" {% if (qr_config.correct_level | default('H')) == 'H' %}selected{% endif %}>H - High (~30% recovery)</option>
                                    </select>
                                </div>
                                
                                <hr>
                                <h6>Logo Options</h6>
                                <div class="mb-3">
                                    <label for="qr_style_logo_image" class="form-label">Logo Image URL</label>
                                    <input type="url" class="form-control" id="qr_style_logo_image" name="qr_style_logo_image" value="{{ qr_config.logo_image | default('') }}" placeholder="https://example.com/logo.png">
                                    <div class="form-text">Optional - URL to an image to embed in the center of the QR code</div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="qr_style_logo_size" class="form-label">Logo Size</label>
                                        <input type="number" class="form-control" id="qr_style_logo_size" name="qr_style_logo_size" value="{{ qr_config.logo_size | default(0.3) }}" step="0.1" min="0.1" max="0.5">
                                        <div class="form-text">Size relative to QR code (0.1-0.5)</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="qr_style_logo_margin" class="form-label">Logo Margin</label>
                                        <input type="number" class="form-control" id="qr_style_logo_margin" name="qr_style_logo_margin" value="{{ qr_config.logo_margin | default(3) }}" min="0" max="10">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Get QR code</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col">
            <div class="card">
                <div class="card-body">
                    <h5 class="mb-3">QR Code Preview</h5>
                    <div id="qrPreview" class="d-flex justify-content-center align-items-center" style="min-height: 200px;">
                        <p class="text-muted">Enter a URL above to see a preview of your QR code</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Debounce utility function
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Shared function to build QR code configuration from form values
function buildQRCodeConfig(formValues, qrCodeUrl) {
    const errorCorrectionMap = {
        "L": "L",
        "M": "M",
        "Q": "Q",
        "H": "H"
    };
    const errorCorrectionLevel = errorCorrectionMap[formValues.correct_level || "H"] || "H";
    
    // Build dots configuration
    const dotsOptions = {
        type: formValues.dot_type || "square",
        color: formValues.color_dark || "#000000"
    };
    
    // Build corners configuration
    const cornersSquareOptions = {
        type: formValues.corner_square_type || "square",
        color: formValues.color_dark || "#000000"
    };
    
    const cornersDotOptions = {
        type: formValues.corner_dot_type || "square",
        color: formValues.color_dark || "#000000"
    };
    
    // Build background configuration
    const backgroundOptions = {
        color: formValues.color_light || "#ffffff"
    }
    
    // Build QR code configuration object
    const size = parseInt(formValues.size) || 512;
    const qrCodeConfig = {
        width: size,
        height: size,
        type: "canvas",
        data: qrCodeUrl,
        margin: parseInt(formValues.margin) || 4,
        qrOptions: {
            typeNumber: 0,
            mode: "Byte",
            errorCorrectionLevel: errorCorrectionLevel
        },
        dotsOptions: dotsOptions,
        cornersSquareOptions: cornersSquareOptions,
        cornersDotOptions: cornersDotOptions,
        backgroundOptions: backgroundOptions
    };
    
    // Add image/logo configuration only if logo is provided
    // According to QRCodeStyling docs: image is top-level, imageOptions contains crossOrigin and other options
    if (formValues.logo_image && typeof formValues.logo_image === 'string' && formValues.logo_image.trim() !== "") {
        qrCodeConfig.image = formValues.logo_image.trim();
        qrCodeConfig.imageOptions = {
            crossOrigin: "anonymous",
            hideBackgroundDots: true,
            margin: parseInt(formValues.logo_margin) || 3,
            imageSize: parseFloat(formValues.logo_size) || 0.3
        };
    }
    
    return qrCodeConfig;
}

// Collect form values from homepage form
function collectHomepageFormValues() {
    const urlField = document.getElementById('url');
    const url = urlField ? urlField.value.trim() : '';
    
    return {
        url: url,
        size: document.getElementById('qr_style_size')?.value || '512',
        color_dark: document.getElementById('qr_style_color_dark')?.value || '#000000',
        color_light: document.getElementById('qr_style_color_light')?.value || '#ffffff',
        dot_type: document.getElementById('qr_style_dot_type')?.value || 'square',
        margin: document.getElementById('qr_style_margin')?.value || '4',
        corner_square_type: document.getElementById('qr_style_corner_square_type')?.value || 'square',
        corner_dot_type: document.getElementById('qr_style_corner_dot_type')?.value || 'square',
        correct_level: document.getElementById('qr_style_correct_level')?.value || 'H',
        logo_image: document.getElementById('qr_style_logo_image')?.value || '',
        logo_size: document.getElementById('qr_style_logo_size')?.value || '0.3',
        logo_margin: document.getElementById('qr_style_logo_margin')?.value || '3',
        gradient_type: document.getElementById('qr_style_gradient_type')?.value || '',
        gradient_color_start: document.getElementById('qr_style_gradient_color_start')?.value || '#000000',
        gradient_color_end: document.getElementById('qr_style_gradient_color_end')?.value || '#000000',
        gradient_rotation: document.getElementById('qr_style_gradient_rotation')?.value || '0',
        background_gradient_type: document.getElementById('qr_style_background_gradient_type')?.value || '',
        background_gradient_color_start: document.getElementById('qr_style_background_gradient_color_start')?.value || '#ffffff',
        background_gradient_color_end: document.getElementById('qr_style_background_gradient_color_end')?.value || '#ffffff',
        background_gradient_rotation: document.getElementById('qr_style_background_gradient_rotation')?.value || '0'
    };
}

// Generate QR code preview for homepage
let homepageQRCodeInstance = null;

function generateQRPreview() {
    // Check if QRCodeStyling is available
    if (typeof QRCodeStyling === 'undefined') {
        const previewElement = document.getElementById('qrPreview');
        if (previewElement) {
            previewElement.innerHTML = '<p class="text-danger">Error: QR code library not loaded. Please refresh the page.</p>';
        }
        return;
    }
    
    const previewElement = document.getElementById('qrPreview');
    if (!previewElement) {
        return;
    }
    
    const formValues = collectHomepageFormValues();
    const url = formValues.url;
    
    // Show placeholder if URL is empty
    if (!url || url === '') {
        previewElement.innerHTML = '<p class="text-muted">Enter a URL above to see a preview of your QR code</p>';
        return;
    }
    
    try {
        // Normalize URL (add https:// if no protocol)
        let qrCodeUrl = url;
        if (qrCodeUrl.indexOf('http://') !== 0 && qrCodeUrl.indexOf('https://') !== 0) {
            qrCodeUrl = 'https://' + qrCodeUrl;
        }
        
        // Clear previous QR code instance
        if (homepageQRCodeInstance) {
            previewElement.innerHTML = '';
            homepageQRCodeInstance = null;
        }
        
        // Build QR code configuration
        const qrCodeConfig = buildQRCodeConfig(formValues, qrCodeUrl);
        
        // Create QR code with styling
        // QRCodeStyling handles image loading internally, so we can pass URL directly
        homepageQRCodeInstance = new QRCodeStyling(qrCodeConfig);
        homepageQRCodeInstance.append(previewElement);
    } catch (error) {
        console.error('Error generating QR code preview:', error);
        previewElement.innerHTML = '<p class="text-danger">Error generating QR code preview. Please check the browser console.</p>';
    }
}

// Debounced version of generateQRPreview
const debouncedGenerateQRPreview = debounce(generateQRPreview, 300);


// Add event listeners to all form fields for preview updates
const formFields = [
    'url', 'qr_style_size', 'qr_style_color_dark', 'qr_style_color_light',
    'qr_style_dot_type', 'qr_style_margin', 'qr_style_corner_square_type', 'qr_style_corner_dot_type',
    'qr_style_correct_level', 'qr_style_logo_image', 'qr_style_logo_size', 'qr_style_logo_margin'
];

formFields.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) {
        field.addEventListener('input', debouncedGenerateQRPreview);
        field.addEventListener('change', debouncedGenerateQRPreview);
    }
});

// Wait for library to load and generate initial preview
function waitForLibraryAndPreview(attempts) {
    attempts = attempts || 0;
    if (attempts > 50) {
        console.error('QRCodeStyling library failed to load after 5 seconds');
        return;
    }
    
    if (typeof QRCodeStyling !== 'undefined') {
        generateQRPreview();
    } else {
        setTimeout(function() { waitForLibraryAndPreview(attempts + 1); }, 100);
    }
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        waitForLibraryAndPreview();
    });
} else {
    waitForLibraryAndPreview();
}
</script>

{% endblock %}
